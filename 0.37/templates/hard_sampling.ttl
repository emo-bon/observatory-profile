{#- 
Template: arms_sampling.ldt.ttl 
Description: Template to generate triples from arms sampling data collected in context of ARMS EMO-BON. 
Input: 
    - observatory-{obs_id}-crate/logsheets-transformed/hard_sampling.csv (name of csv file to be determined)
Sets: 
    - observatory-{obs_id}-crate/logsheets-transformed/sediment_observatory.csv as observatory
-#}

{% include './includes/prefixes.ttl' %}

{# Need to retrieve obsID_low, env and ARMS_unit_id from source_mat_id ...  This assumes consistent structure of source_mat_id #}
{% set namesarr = _.source_mat_id.split('_') %}
{% set obsID_low = namesarr[1] | lower %}
{% set ARMS_unit_id_low = namesarr[2] | lower %}
{% set env =  namesarr[3] %}
{% set samplingEvent =  _.sampling_event.split(' ') |join("_") %} {# looking at logsheets, likely not needed but consistent with other observatory templates #}

@base {{ "http://data.emobon.embrc.eu/observatory-" ~ obsID_low ~ "-crate/" ~ env ~ "/sampling-event/" ~ samplingEvent | uri }} . {# baseref ~ http://data.emobon.embrc.eu #}

{#- SAMPLING EVENT #}
<> 
    a sosa:Sampling, prov:Activity ;  
    {# provenance part #}
    dct:type "sampling"^^xsd:string ; 
    {%- if _.collection_date and _.collection_date != "NA" %}
    prov:startedAtTime {{_.collection_date | xsd("auto-date") }} ; {#ValueError: ISO string too short with xsd:date#}
    {%- endif %}
    prov:wasAssociatedWith [
        a prov:Person, schema:Person ;
        {%- if _.sampl_person != "NA" %}
        schema:name {{ _.sampl_person | xsd("string") }} ;
        {%- endif %}
        {%- if _.sampl_person_orcid and _.sampl_person_orcid != "NA" %}
        schema:identifier {{_.sampl_person_orcid | xsd("anyURI") }} ;
        {%- endif %}
    ] ;
    {# properties #}
    {%- if _.collection_date and _.collection_date != "NA" %}
    sosa:resultTime {{ _.collection_date | xsd("auto-date") }} ; {#xsd:dateTime not supported#}
    {%- endif %}
    {%- if _.samp_collect_device != "NA" %}
    sosa:madeBySampler {{ _.samp_collect_device | xsd("string") }} ; 
    {%- endif %}
    {%- if _.samp_mat_process != "NA" or _.samp_mat_process_dev != "NA" %}
    sosa:usedProcedure [
        a sosa:Procedure ; 
        {%- if _.samp_mat_process != "NA" %}
        rdfs:label {{ _.samp_mat_process | xsd("string") }} ;
        {%- endif %}
        {%- if _.samp_mat_process_dev != "NA" %}
        rdfs:comment {{ _.samp_mat_process_dev | xsd("string") }} ; 
        {%- endif %}
        rdfs:seeAlso "http://dx.doi.org/10.25607/OBP-1653"^^xsd:anyURI ;
        ] ; 
    {%- endif %}
    {%- if _.tidal_stage != "NA" %}
    emobon-sampling:tidalStage {{_.tidal_stage | xsd("string") }} ;
    {%- endif %}
    {%- if _.depth and _.depth != "NA" %}
        {%- if _.depth.startswith('>')%} {#case 1: > #}
    emobon-sampling:minSamplingDepth [
        a qudt:QuantityValue ;
        qudt:numericValue {{ _.depth | xsd("double") }} ; 
        {%- for row in sets['schema']%}
            {%- if row['LogsheetColumnTitle'] == 'depth' %}
                {%- if row['Unit_URL'] and row['Unit_URL'] != "NA" %}
        qudt:unit {{row['Unit_URL'].strip() | uri }} ;
                {%- elif row['Unit'] and row['Unit'] != "NA" %}
        qudt:unit {{row['Unit'].strip() | xsd('string') }} ;
                {%- endif %} 
            {%- endif %}
        {%- endfor %} 
        ] ; 
        {%- elif _.depth.startswith('<')%} {#case 2: < #}
    emobon-sampling:maxSamplingDepth [
        a qudt:QuantityValue ;
        qudt:numericValue {{ _.depth | xsd("double") }} ; 
        {%- for row in sets['schema']%}
            {%- if row['LogsheetColumnTitle'] == 'depth' %}
                {%- if row['Unit_URL'] and row['Unit_URL'] != "NA" %}
        qudt:unit {{row['Unit_URL'].strip() | uri }} ;
                {%- elif row['Unit'] and row['Unit'] != "NA" %}
        qudt:unit {{row['Unit'].strip() | xsd('string') }} ;
                {%- endif %} 
            {%- endif %}
        {%- endfor %} 
        ] ; 
        {%- elif '-' in _.depth %} {# case 3: range x-y/x-x (assuming smallest always first) #}
            {% set x,y = _.depth.split('-') %}
    emobon-sampling:minSamplingDepth [
        a qudt:QuantityValue ;
        qudt:numericValue {{ x | xsd("double") }} ; 
        {%- for row in sets['schema']%}
            {%- if row['LogsheetColumnTitle'] == 'depth' %}
                {%- if row['Unit_URL'] and row['Unit_URL'] != "NA" %}
        qudt:unit {{row['Unit_URL'].strip() | uri }} ;
                {%- elif row['Unit'] and row['Unit'] != "NA" %}
        qudt:unit {{row['Unit'].strip() | xsd('string') }} ;
                {%- endif %} 
            {%- endif %}
        {%- endfor %} 
        ] ;  
    emobon-sampling:maxSamplingDepth [
        a qudt:QuantityValue ;
        qudt:numericValue {{ y | xsd("double") }} ; 
        {%- for row in sets['schema']%}
            {%- if row['LogsheetColumnTitle'] == 'depth' %}
                {%- if row['Unit_URL'] and row['Unit_URL'] != "NA" %}
        qudt:unit {{row['Unit_URL'].strip() | uri }} ;
                {%- elif row['Unit'] and row['Unit'] != "NA" %}
        qudt:unit {{row['Unit'].strip() | xsd('string') }} ;
                {%- endif %} 
            {%- endif %}
        {%- endfor %} 
        ] ; 
        {%- else %} {# case 4: single value #}
    emobon-sampling:minSamplingDepth [
        a qudt:QuantityValue ;
        qudt:numericValue {{ _.depth | xsd("double") }} ; 
        {%- for row in sets['schema']%}
            {%- if row['LogsheetColumnTitle'] == 'depth' %}
                {%- if row['Unit_URL'] and row['Unit_URL'] != "NA" %}
        qudt:unit {{row['Unit_URL'].strip() | uri }} ;
                {%- elif row['Unit'] and row['Unit'] != "NA" %}
        qudt:unit {{row['Unit'].strip() | xsd('string') }} ;
                {%- endif %} 
            {%- endif %}
        {%- endfor %} 
        ] ; 
    emobon-sampling:maxSamplingDepth [
        a qudt:QuantityValue ;
        qudt:numericValue {{ _.depth | xsd("double") }} ; 
        {%- for row in sets['schema']%}
            {%- if row['LogsheetColumnTitle'] == 'depth' %}
                {%- if row['Unit_URL'] and row['Unit_URL'] != "NA" %}
        qudt:unit {{row['Unit_URL'].strip() | uri }} ;
                {%- elif row['Unit'] and row['Unit'] != "NA" %}
        qudt:unit {{row['Unit'].strip() | xsd('string') }} ;
                {%- endif %} 
            {%- endif %}
        {%- endfor %} 
        ] ; 
        {%- endif %}
    {#emobon-sampling:samplingDepth {{ _.depth | xsd("string") }} ; #}
    {%- endif %}
    {%- if observatory.tot_depth_water_col != "NA" %}
    emobon-core:waterColumnDepth {{observatory.tot_depth_water_col | xsd("string") }} ; {#info from observ file - better suited here#}
    {%- endif %}
    {%- if observatory.geo_loc_name != "NA" %}
    emobon-core:originCountry {{observatory.geo_loc_name | xsd("string") }} ; 
    {%- endif %}
    {# features of interest #}
    {%- if _.env_material != "NA" %}
    emobon-sampling:environmentMaterial {% for item in _.env_material.split(';') %}{{item.strip() | xsd("anyURI") }}{% if not loop.last %}, {%endif%}{% endfor %};
    {%- endif %}
    {%- if _.investigation_type != "NA" %}
    emobon-sampling:investigationType {{_.investigation_type | xsd("string") }} ;
    {%- endif %}
    {%- if _.tax_id != "NA" %}
    emobon-sampling:taxonomicID {{_.tax_id | xsd("anyURI") }} ;
    {%- endif %} 
    {%- if _.scientific_name != "NA" %}
    emobon-sampling:taxonomicName {{_.scientific_name | xsd("string") }} ;
    {%- endif %}
    {%- if _.comm_samp != "NA" %}
    emobon-sampling:bioCommunity {{ _.comm_samp | xsd("string") }} ; 
    {%- endif %}
    {# linked to observatory #}
    emobon-sampling:linkedToObservatory {{ "/observatory-" ~ obsID_low ~ "-crate/" ~ env ~ "/observatory/" ~ obsID_low ~ "-" ~ ARMS_unit_id_low| uri }} ; 
.